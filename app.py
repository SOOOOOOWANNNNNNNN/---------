import streamlit as st
import requests
import json
import os
from dotenv import load_dotenv

# --------------------------------------------------------------------------
# [ëª©ì ] .env íŒŒì¼ ë˜ëŠ” ìŠ¤íŠ¸ë¦¼ë¦¿ í´ë¼ìš°ë“œì˜ Secretsì—ì„œ í™˜ê²½ ë³€ìˆ˜(API Key)ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
# [ê²°ê³¼] ì†ŒìŠ¤ ì½”ë“œì— ë¹„ë°€ë²ˆí˜¸ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê³  ì•ˆì „í•˜ê²Œ í‚¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# --------------------------------------------------------------------------
load_dotenv() 

# --------------------------------------------------------------------------
# [ëª©ì ] ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íƒ­ ì´ë¦„, ì•„ì´ì½˜, ê¸°ë³¸ ë ˆì´ì•„ì›ƒì„ ì„¤ì •í•©ë‹ˆë‹¤.
# [ê²°ê³¼] ë¸Œë¼ìš°ì € ìƒë‹¨ íƒ­ì— 'ì§€ë¦¬ ì²™ì²™ë°•ì‚¬ë‹˜'ì´ í‘œì‹œë˜ê³ , ì§€êµ¬ ì•„ì´ì½˜ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
# --------------------------------------------------------------------------
st.set_page_config(page_title="ìš°ë¦¬ë‚˜ë¼ ì§€ë¦¬ ì²™ì²™ë°•ì‚¬ë‹˜", page_icon="ğŸŒ")

st.title("ğŸŒ ì²™ì²™ë°•ì‚¬ ì§€ë¦¬ ì„ ìƒë‹˜")
st.caption("ê¶ê¸ˆí•œ ì§€ì—­ì„ ì…ë ¥í•˜ê±°ë‚˜, ì™¼ìª½ì—ì„œ ê³¨ë¼ë³´ì„¸ìš”! (ì˜ˆ: ë…ë„, ì„œìš¸)")

# --------------------------------------------------------------------------
# [ëª©ì ] í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. (ë¡œì»¬: .env / ë°°í¬: Secrets)
# [ê²°ê³¼] ì‚¬ìš©ìê°€ í‚¤ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ í”„ë¡œê·¸ë¨ì´ ìë™ìœ¼ë¡œ ì¸ì¦ ì •ë³´ë¥¼ ì¸ì‹í•©ë‹ˆë‹¤.
# --------------------------------------------------------------------------
api_key = os.getenv("GEMINI_API_KEY")

# --------------------------------------------------------------------------
# [ëª©ì ] ì™¼ìª½ ì‚¬ì´ë“œë°”ì— ëŒ€í‘œ ì§€ì—­ ì„ íƒ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ì í¸ì˜ì„±ì„ ë†’ì…ë‹ˆë‹¤.
# [ê²°ê³¼] íƒ€ìê°€ ìµìˆ™í•˜ì§€ ì•Šì€ í•™ìƒë“¤ë„ í´ë¦­ë§Œìœ¼ë¡œ ì§ˆë¬¸í•  ìˆ˜ ìˆëŠ” ë©”ë‰´ê°€ ì™¼ìª½ì— ìƒê¹ë‹ˆë‹¤.
# --------------------------------------------------------------------------
with st.sidebar:
    st.header("ğŸ—ºï¸ ì§€ì—­ ê³¨ë¼ë³´ê¸°")
    selected_location = st.selectbox(
        "ê¶ê¸ˆí•œ ì§€ì—­ì„ ì„ íƒí•˜ê³  'ì§ˆë¬¸í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!",
        ["ì§ì ‘ ì…ë ¥", "ë…ë„", "ì œì£¼ë„", "ê²½ì£¼", "ì„œìš¸", "ë¶€ì‚°", "í‰ì–‘"]
    )
    is_sidebar_clicked = st.button("ì´ ì§€ì—­ ì§ˆë¬¸í•˜ê¸°")

# --------------------------------------------------------------------------
# [ëª©ì ] AIì—ê²Œ 'ì¹œì ˆí•œ ìœ ì¹˜ì› ì„ ìƒë‹˜' ì—­í• ì„ ë¶€ì—¬í•˜ê³  ë‹µë³€ í˜•ì‹ì„ ì§€ì •í•©ë‹ˆë‹¤.
# [ê²°ê³¼] AIê°€ ê¸°ê³„ì ì¸ ì •ë³´ ëŒ€ì‹ , ì•„ì´ë“¤ ëˆˆë†’ì´ì— ë§ì¶˜ ë‹¤ì •í•œ ë§íˆ¬ì™€ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
# --------------------------------------------------------------------------
system_instruction = """
ë‹¹ì‹ ì€ ì•„ì´ë“¤ì„ ì •ë§ ì‚¬ë‘í•˜ëŠ” 5ë…„ ì°¨ ë² í…Œë‘ ìœ ì¹˜ì› ì„ ìƒë‹˜ì…ë‹ˆë‹¤. 
ë‹¤ìŒ ì›ì¹™ì„ ì§€ì¼œì„œ ë‹µë³€í•´ì£¼ì„¸ìš”:
1. ë§íˆ¬: "ì¹œêµ¬ë“¤~", "~í•´ìš”" ì²˜ëŸ¼ ì•„ì£¼ ì¹œì ˆí•˜ê³  ë‹¤ì •í•˜ê²Œ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì„¸ìš”.
2. í•„ìˆ˜: ë‹µë³€ì—ëŠ” ë°˜ë“œì‹œ ì´ëª¨ì§€(ğŸ˜Š, ğŸŒ³, ğŸŒŠ ë“±)ë¥¼ ì•„ì£¼ í’ë¶€í•˜ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.
3. ì„ë¬´: ì‚¬ìš©ìê°€ 'ì§€ì—­ ì´ë¦„'ì„ ë¬¼ì–´ë³´ë©´, ì´ˆë“±í•™ìƒ ëˆˆë†’ì´ì— ë§ì¶°ì„œ ë‹¤ìŒ ë‚´ìš©ì„ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
   - ğŸ“ ìœ„ì¹˜: ì–´ë””ì— ìˆëŠ”ì§€
   - âœ¨ íŠ¹ì§•: ë¬´ì—‡ì´ ìœ ëª…í•œì§€, ì–´ë–¤ ì¬ë¯¸ìˆëŠ” ì ì´ ìˆëŠ”ì§€
   - ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ì¸êµ¬ìˆ˜: ëŒ€ëµ ì–¼ë§ˆë‚˜ ë§ì€ ì‚¬ëŒì´ ì‚´ê³  ìˆëŠ”ì§€
4. ë§Œì•½ ì§€ë¦¬ì  ì§€ëª…ì´ ì•„ë‹Œ ì§ˆë¬¸ì„ í•˜ë©´ "ì„ ìƒë‹˜ì€ ì§€ë¦¬ ê³µë¶€ë§Œ ë„ì™€ì¤„ ìˆ˜ ìˆì–´ìš”~ ë‹¤ë¥¸ ì§€ì—­ì„ ë¬¼ì–´ë´ ì¤„ë˜ìš”? ğŸ—ºï¸"ë¼ê³  ë‹µí•´ì£¼ì„¸ìš”.
"""

# --------------------------------------------------------------------------
# [ëª©ì ] ìƒˆë¡œê³ ì¹¨ ì‹œ ëŒ€í™” ë‚´ìš©ì´ ì‚¬ë¼ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì €ì¥ì†Œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
# [ê²°ê³¼] ì´ì „ ëŒ€í™” ê¸°ë¡ì´ ìœ ì§€ë˜ì–´ ë¬¸ë§¥ì´ ëŠê¸°ì§€ ì•ŠëŠ” ì±„íŒ… ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.
# --------------------------------------------------------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []

# --------------------------------------------------------------------------
# [ëª©ì ] ì €ì¥ëœ ëŒ€í™” ê¸°ë¡ì„ í™”ë©´ì— ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ í‘œì‹œí•©ë‹ˆë‹¤.
# [ê²°ê³¼] ì‚¬ìš©ìì™€ AIê°€ ì£¼ê³ ë°›ì€ ë§í’ì„ ë“¤ì´ ì±„íŒ…ì°½ í˜•íƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
# --------------------------------------------------------------------------
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --------------------------------------------------------------------------
# [ëª©ì ] ì§ì ‘ ì…ë ¥ê³¼ ì‚¬ì´ë“œë°” ì„ íƒ, ë‘ ê°€ì§€ ë°©ì‹ì„ í†µí•©í•˜ì—¬ ì§ˆë¬¸ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
# [ê²°ê³¼] ì–´ë””ì„œ ì…ë ¥ì„ í•˜ë“  ë™ì¼í•˜ê²Œ AIì—ê²Œ ì§ˆë¬¸ì´ ì „ë‹¬ë©ë‹ˆë‹¤.
# --------------------------------------------------------------------------
prompt = None
if user_input := st.chat_input("ì§€ì—­ ì´ë¦„ì„ ì…ë ¥í•´ë³¼ê¹Œìš”?"):
    prompt = user_input
elif is_sidebar_clicked and selected_location != "ì§ì ‘ ì…ë ¥":
    prompt = selected_location

if prompt:
    # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    with st.chat_message("user"):
        st.markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # API í‚¤ í™•ì¸
    if not api_key:
        st.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Secrets ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        st.stop()

    
    # 3. Gemini API ìš”ì²­ ì£¼ì†Œ (ìµœì‹  Gemini 2.5 flash ì ìš©)
   
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}"
    headers = {'Content-Type': 'application/json'}
    
    # ... (ì•„ë˜ìª½ ì½”ë“œëŠ” ë™ì¼) ...
    headers = {'Content-Type': 'application/json'}
    payload = {
        "contents": [{"parts": [{"text": system_instruction + "\n\nì§ˆë¬¸: " + prompt}]}]
    }

    # ì‘ë‹µ ì²˜ë¦¬ ë° ì˜ˆì™¸ ì²˜ë¦¬
    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        message_placeholder.markdown("ì„ ìƒë‹˜ì´ ìƒê°í•˜ê³  ìˆì–´ìš”... ğŸ¤”")
        
        try:
            response = requests.post(url, headers=headers, data=json.dumps(payload))
            
            # [ëª©ì ] ì‘ë‹µ ìƒíƒœ ì½”ë“œì— ë”°ë¼ ì„±ê³µê³¼ ì‹¤íŒ¨(429, 404 ë“±)ë¥¼ êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            if response.status_code == 200:
                result = response.json()
                bot_response = result['candidates'][0]['content']['parts'][0]['text']
                message_placeholder.markdown(bot_response)
                st.session_state.messages.append({"role": "assistant", "content": bot_response})
            
            elif response.status_code == 429:
                # [ê²°ê³¼] ìš”ì²­ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ì‚¬ìš©ìì—ê²Œ ëŒ€ê¸°í•˜ë¼ëŠ” ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë„ì›ë‹ˆë‹¤.
                message_placeholder.error("ì§ˆë¬¸ì´ ë„ˆë¬´ ë§ì•„ìš”! 1ë¶„ë§Œ ì‰¬ì—ˆë‹¤ê°€ ë‹¤ì‹œ ë¬¼ì–´ë´ì£¼ì„¸ìš”. ğŸ˜…")
            
            else:
                message_placeholder.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {response.status_code}")
                
        except Exception as e:
            message_placeholder.error(f"ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")